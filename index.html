<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Cesium + WebXR Viewer</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: black;
    }
    #enterAR, #exitAR, #tokenForm, #gpsStatus {
      position: absolute; z-index: 1000; font-size: 20px;
    }
    #enterAR {
      top: 10px; left: 10px; padding: 24px 36px; background: #28a745; color: white; border-radius: 6px; cursor: pointer;
    }
    #exitAR {
      top: 10px; right: 10px; padding: 24px 36px; background: #dc3545; color: white; border-radius: 6px; cursor: pointer; display: none;
    }
    #tokenForm {
      top: 120px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 6px;
    }
    #tokenForm input {
      width: 400px; margin-bottom: 15px; font-size: 20px; padding: 6px;
    }
    #tokenForm button {
      padding: 16px 24px; font-size: 20px; margin-top: 10px;
    }
    canvas.xr-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #messageBox {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-size: 18px;
      z-index: 1100;
      display: none;
    }
    #gpsStatus {
      bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px 14px; border-radius: 6px; font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="enterAR" disabled>Войти в AR</button>
  <button id="exitAR">Выйти из AR</button>
  <div id="tokenForm">
    <div>
      Access Token: <input id="accessToken" placeholder="Вставьте Access Token">
    </div>
    <div>
      Asset ID: <input id="assetId" placeholder="Вставьте Asset ID">
    </div>
    <button id="loadScene">Загрузить сцену</button>
    <button id="connectRTK">Подключиться к RTK (USB)</button>
  </div>
  <div id="messageBox"></div>
  <div id="gpsStatus">Ожидание GPS...</div>
  <script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.150.1';

    let viewer, gpsEntity = null, hasCentered = false, arRenderer = null;

    function showMessage(message) {
      const box = document.getElementById('messageBox');
      box.textContent = message;
      box.style.display = 'block';
      setTimeout(() => box.style.display = 'none', 4000);
    }

    function validateInputs() {
      const token = document.getElementById('accessToken').value.trim();
      const assetId = document.getElementById('assetId').value.trim();
      document.getElementById('enterAR').disabled = !(token && assetId);
    }

    document.getElementById('accessToken').addEventListener('input', validateInputs);
    document.getElementById('assetId').addEventListener('input', validateInputs);

    async function loadScene(token, assetId) {
      Cesium.Ion.defaultAccessToken = token;
      if (!viewer) {
        viewer = new Cesium.Viewer('cesiumContainer', {
          imageryProvider: new Cesium.IonImageryProvider({ assetId: 2 }),
          baseLayerPicker: true,
          shouldAnimate: true,
          scene3DOnly: true,
          shadows: true,
          useDefaultRenderLoop: true,
        });
        viewer.scene.globe.depthTestAgainstTerrain = true;
      }

      viewer.terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1);
      viewer.dataSources.removeAll();
      try {
        const resource = await Cesium.IonResource.fromAssetId(Number(assetId));
        const kmlDataSource = await Cesium.KmlDataSource.load(resource, {
          camera: viewer.scene.camera,
          canvas: viewer.scene.canvas,
          clampToGround: true
        });
        const dataSource = await viewer.dataSources.add(kmlDataSource);
        console.log("KML загружен, центрируем камеру...");
        if (viewer.scene && viewer.scene.camera) {
          viewer.flyTo(dataSource);
        }
      } catch (error) {
        console.error("Ошибка загрузки KML:", error);
        alert("Ошибка загрузки сцены. Проверьте Asset ID и Token.");
      }
    }

    document.getElementById('loadScene').onclick = async () => {
      const token = document.getElementById('accessToken').value.trim();
      const assetId = document.getElementById('assetId').value.trim();
      if (!token || !assetId) {
        alert("Пожалуйста, введите Access Token и Asset ID");
        return;
      }
      localStorage.setItem('cesiumToken', token);
      localStorage.setItem('cesiumAssetId', assetId);
      await loadScene(token, assetId);
    };

    document.getElementById('connectRTK').onclick = async () => {
      try {
        if (!('serial' in navigator) || typeof navigator.serial.requestPort !== 'function') {
          throw new Error("Serial API не поддерживается в этом браузере. Используйте Chrome с Experimental Web Platform features.");
        }
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        showMessage("Подключено к RTK по USB");
      } catch (err) {
        showMessage("Ошибка Serial API: " + err.message);
      }
    };

    document.getElementById('enterAR').onclick = async () => {
      if (!navigator.xr) {
        showMessage("WebXR не поддерживается на этом устройстве.");
        return;
      }
      const supported = await navigator.xr.isSessionSupported('immersive-ar');
      if (!supported) {
        showMessage("AR-сессии не поддерживаются на этом устройстве.");
        return;
      }
      try {
        const session = await navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['viewer'],
          optionalFeatures: ['dom-overlay'],
          domOverlay: { root: document.body }
        });
        showMessage("WebXR AR-сессия успешно запущена!");
        arRenderer = new THREE.WebGLRenderer({ alpha: true });
        arRenderer.setSize(window.innerWidth, window.innerHeight);
        arRenderer.xr.enabled = true;
        document.body.appendChild(arRenderer.domElement);
        arRenderer.xr.setSession(session);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
        scene.add(camera);
        const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(0, 0, -1);
        scene.add(cube);
        arRenderer.setAnimationLoop(() => {
          arRenderer.render(scene, camera);
        });
        session.addEventListener('end', () => {
          arRenderer.setAnimationLoop(null);
          if (arRenderer.domElement && arRenderer.domElement.remove) {
            arRenderer.domElement.remove();
          }
        });
      } catch (error) {
        showMessage("Ошибка AR-сессии: " + error.message);
      }
    };

    window.onload = async () => {
      const token = localStorage.getItem('cesiumToken');
      const assetId = localStorage.getItem('cesiumAssetId');
      if (token && assetId) {
        document.getElementById('accessToken').value = token;
        document.getElementById('assetId').value = assetId;
        validateInputs();
        await loadScene(token, assetId);
      }
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const position = Cesium.Cartesian3.fromDegrees(lon, lat, 0);
          if (!gpsEntity && viewer) {
            gpsEntity = viewer.entities.add({
              id: 'gps-entity',
              position: position,
              point: {
                pixelSize: 16,
                color: Cesium.Color.RED,
                disableDepthTestDistance: Number.POSITIVE_INFINITY
              },
              label: {
                text: "GPS",
                font: 'bold 16px sans-serif',
                fillColor: Cesium.Color.WHITE,
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                disableDepthTestDistance: Number.POSITIVE_INFINITY
              }
            });
          } else if (gpsEntity) {
            gpsEntity.position = position;
          }
          if (!hasCentered && viewer) {
            viewer.camera.flyTo({ destination: position });
            hasCentered = true;
          }
          if (viewer) viewer.trackedEntity = gpsEntity;
          document.getElementById('gpsStatus').textContent = `GPS: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        }, err => {
          document.getElementById('gpsStatus').textContent = "Ошибка GPS: " + err.message;
        }, { enableHighAccuracy: true });
      } else {
        document.getElementById('gpsStatus').textContent = "GPS недоступен в браузере";
      }
    };
  </script>
</body>
</html>
