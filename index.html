<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Cesium + WebXR Viewer</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: black;
    }
    #enterAR, #exitAR, #tokenForm, #gpsStatus {
      position: absolute; z-index: 1000; font-size: 16px;
    }
    #enterAR {
      top: 10px; left: 10px; padding: 12px 20px; background: #28a745; color: white; border-radius: 6px; cursor: pointer;
    }
    #exitAR {
      top: 10px; right: 10px; padding: 12px 20px; background: #dc3545; color: white; border-radius: 6px; cursor: pointer; display: none;
    }
    #tokenForm {
      top: 60px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 6px;
    }
    #tokenForm input { width: 250px; margin-bottom: 5px; }
    #gpsStatus {
      bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px; border-radius: 6px;
    }
    canvas.xr-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #messageBox {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-size: 18px;
      z-index: 1100;
      display: none;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="enterAR" disabled>Войти в AR</button>
  <button id="exitAR">Выйти из AR</button>
  <div id="tokenForm">
    <div>
      Access Token: <input id="accessToken" placeholder="Вставьте Access Token">
    </div>
    <div>
      Asset ID: <input id="assetId" placeholder="Вставьте Asset ID">
    </div>
    <button id="loadScene">Загрузить сцену</button>
    <button id="connectRTK">Подключиться к RTK (Bluetooth)</button>
  </div>
  <div id="gpsStatus">Ожидание GPS...</div>
  <div id="messageBox"></div>

  <script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.150.1';

    let viewer, cesiumEntity = null;
    let rtkStream = null;
    let rtkPosition = null;

    function initializeViewer() {
      viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider: Cesium.createWorldTerrain(),
        shouldAnimate: true,
      });
    }

    function saveCredentials() {
      localStorage.setItem('accessToken', document.getElementById('accessToken').value);
      localStorage.setItem('assetId', document.getElementById('assetId').value);
    }

    function loadCredentials() {
      const token = localStorage.getItem('accessToken');
      const id = localStorage.getItem('assetId');
      if (token) document.getElementById('accessToken').value = token;
      if (id) document.getElementById('assetId').value = id;
    }

    async function loadScene() {
      const token = document.getElementById('accessToken').value;
      const assetId = document.getElementById('assetId').value;
      if (!token || !assetId) return alert("Введите Access Token и Asset ID");
      saveCredentials();
      Cesium.Ion.defaultAccessToken = token;
      viewer.scene.primitives.removeAll();
      const resource = await Cesium.IonResource.fromAssetId(parseInt(assetId));
      viewer.scene.primitives.add(await Cesium.Cesium3DTileset.fromIonAssetId(parseInt(assetId)));
    }

    async function connectRTK() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "RTK" }],
          optionalServices: ["00001101-0000-1000-8000-00805f9b34fb"]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("00001101-0000-1000-8000-00805f9b34fb");
        const characteristic = await service.getCharacteristic("00002a00-0000-1000-8000-00805f9b34fb");

        characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', event => {
          const data = new TextDecoder().decode(event.target.value);
          parseNMEA(data);
        });

        document.getElementById('gpsStatus').textContent = "RTK GPS подключён (Bluetooth)";
      } catch (err) {
        console.error("Ошибка подключения к RTK:", err);
        document.getElementById('gpsStatus').textContent = "Ошибка подключения к RTK. Используется встроенный GPS.";
        fallbackToGeolocation();
      }
    }

    function parseNMEA(data) {
      const lines = data.split("\n");
      for (let line of lines) {
        if (line.startsWith("$GPGGA")) {
          const parts = line.split(",");
          const lat = convertDMSToDD(parts[2], parts[3]);
          const lon = convertDMSToDD(parts[4], parts[5]);
          if (!isNaN(lat) && !isNaN(lon)) {
            rtkPosition = { latitude: lat, longitude: lon };
            updateCesiumPosition();
          }
        }
      }
    }

    function convertDMSToDD(dms, direction) {
      if (!dms || dms.length < 4) return NaN;
      const degrees = parseInt(dms.substring(0, dms.length - 7));
      const minutes = parseFloat(dms.substring(dms.length - 7));
      let dd = degrees + minutes / 60;
      if (direction === 'S' || direction === 'W') dd *= -1;
      return dd;
    }

    function updateCesiumPosition() {
      if (!viewer || !rtkPosition) return;
      if (!cesiumEntity) {
        cesiumEntity = viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(rtkPosition.longitude, rtkPosition.latitude),
          point: { pixelSize: 10, color: Cesium.Color.RED, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 },
          label: { text: "Вы здесь", font: '14px sans-serif', fillColor: Cesium.Color.YELLOW }
        });
      } else {
        cesiumEntity.position = Cesium.Cartesian3.fromDegrees(rtkPosition.longitude, rtkPosition.latitude);
      }
    }

    function fallbackToGeolocation() {
      if (!navigator.geolocation) return;
      navigator.geolocation.watchPosition(pos => {
        rtkPosition = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
        updateCesiumPosition();
        document.getElementById('gpsStatus').textContent = "Используется встроенный GPS";
      }, err => {
        console.warn("Ошибка геолокации:", err);
        document.getElementById('gpsStatus').textContent = "Нет доступа к геолокации";
      }, { enableHighAccuracy: true });
    }

    document.getElementById('connectRTK').onclick = connectRTK;
    document.getElementById('loadScene').onclick = loadScene;

    loadCredentials();
    initializeViewer();
  </script>
</body>
</html>
